from vkbottle import BaseMiddleware
from vkbottle.bot import Message
from database.models import User
import time
import re
from settings import RATE_LIMIT_SECONDS, STARTING_BALANCE, VK_GROUP_ID

user_last_msg = {}

class SystemMiddleware(BaseMiddleware[Message]):
    """
    Middleware Ğ´Ğ»Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¾Ğº:
    - ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ñ‚ĞµĞºÑÑ‚Ğ° Ğ¾Ñ‚ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ½Ğ¸Ğ¹ Ğ¸ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸
    - Throttling (Ğ°Ğ½Ñ‚Ğ¸-ÑĞ¿Ğ°Ğ¼)
    - ĞĞ²Ñ‚Ğ¾-Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
    - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ±Ğ°Ğ½Ğ°
    """
    
    async def pre(self):
        # Ğ˜Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµÑÑ‚Ğ²
        if self.event.from_id < 0:
            self.stop("Group message")
            return

        text = self.event.text
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # 1. Ğ§Ğ˜Ğ¡Ğ¢ĞšĞ ĞĞ¢ Ğ£ĞŸĞĞœĞ˜ĞĞĞĞ˜Ğ™ Ğ‘ĞĞ¢Ğ
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if VK_GROUP_ID > 0:
            # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ [club123|...], [public123|...], @club123
            patterns = [
                rf"\[(?:club|public){VK_GROUP_ID}\|.*?\]",
                rf"\[id{VK_GROUP_ID}\|.*?\]",  # ĞĞ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹ ĞµÑĞ»Ğ¸ Ğ±Ğ¾Ñ‚ - ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ğ°
                rf"@(?:club|public){VK_GROUP_ID}",
                rf"@id{VK_GROUP_ID}"
            ]
            for pat in patterns:
                text = re.sub(pat, "", text, flags=re.IGNORECASE)
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # 2. Ğ§Ğ˜Ğ¡Ğ¢ĞšĞ ĞĞ¢ Ğ­ĞœĞĞ”Ğ—Ğ˜ Ğ˜ Ğ¡Ğ˜ĞœĞ’ĞĞ›ĞĞ’ Ğ’ ĞĞĞ§ĞĞ›Ğ•
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ Ğ²ÑÑ‘ Ñ‡Ñ‚Ğ¾ ĞĞ• ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ±ÑƒĞºĞ²Ğ¾Ğ¹/Ñ†Ğ¸Ñ„Ñ€Ğ¾Ğ¹ Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¸
        # Ğ­Ñ‚Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ "ğŸ’° ", "ğŸ‘¤ ", "!!! ", ">>> " Ğ¿ĞµÑ€ĞµĞ´ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹
        # ĞĞ¾ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ ÑĞ°Ğ¼Ñƒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ Ğ½ĞµĞ¿Ğ¾Ğ²Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ½Ğ¾Ğ¹
        
        # Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° ÑƒĞ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ñ‹
        text = text.lstrip()
        
        # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ½Ğµ-Ğ±ÑƒĞºĞ²ĞµĞ½Ğ½Ğ¾-Ñ†Ğ¸Ñ„Ñ€Ğ¾Ğ²Ñ‹Ğµ ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ Ğ² Ğ½Ğ°Ñ‡Ğ°Ğ»Ğµ
        # ĞĞ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ñ‚Ğ¸Ğ¿Ğ° "!ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°" Ğ¸Ğ»Ğ¸ "+Ñ€ĞµĞ¿"
        if text and not text[0].isalnum() and text[0] not in ['!', '+', '-', '/', '.']:
            # ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ¿ĞµÑ€Ğ²ÑƒÑ Ğ±ÑƒĞºĞ²Ñƒ/Ñ†Ğ¸Ñ„Ñ€Ñƒ Ğ¸Ğ»Ğ¸ ÑĞ¿ĞµÑ†ÑĞ¸Ğ¼Ğ²Ğ¾Ğ» ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
            match = re.search(r'[a-zA-ZĞ°-ÑĞ-Ğ¯Ñ‘Ğ0-9!+\-/.]', text)
            if match:
                text = text[match.start():]
        
        # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ğ±Ñ€ĞµĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»Ğ¾Ğ²
        text = text.strip()
        
        self.event.text = text
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # 3. THROTTLING (ĞĞĞ¢Ğ˜-Ğ¡ĞŸĞĞœ)
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        user_id = self.event.from_id
        now = time.time()
        last_time = user_last_msg.get(user_id, 0)
        
        if now - last_time < RATE_LIMIT_SECONDS:
            self.stop("Throttled")
            return
        
        user_last_msg[user_id] = now
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # 4. ĞĞ’Ğ¢Ğ-Ğ Ğ•Ğ“Ğ˜Ğ¡Ğ¢Ğ ĞĞ¦Ğ˜Ğ¯ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¯
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        user = await User.get_or_none(vk_id=user_id)
        
        if not user:
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¸Ğ· VK API
            first_name = "ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹"
            last_name = "Ğ˜Ğ³Ñ€Ğ¾Ğº"
            
            try:
                user_infos = await self.event.ctx_api.users.get([user_id])
                if user_infos:
                    first_name = user_infos[0].first_name
                    last_name = user_infos[0].last_name
            except Exception as e:
                print(f"âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¸Ğ¼ĞµĞ½Ğ¸: {e}")
            
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            user = await User.create(
                vk_id=user_id,
                first_name=first_name,
                last_name=last_name,
                balance=STARTING_BALANCE
            )
            
            print(f"âœ¨ ĞĞ¾Ğ²Ñ‹Ğ¹ Ğ¸Ğ³Ñ€Ğ¾Ğº: {first_name} {last_name} (ID: {user_id})")
        
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        # 5. ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ Ğ‘ĞĞĞ
        # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        if user.is_banned:
            self.stop("Banned user")
            return
        
        # ĞŸĞµÑ€ĞµĞ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ² Ñ…ĞµĞ½Ğ´Ğ»ĞµÑ€
        self.send({"user_db": user})
