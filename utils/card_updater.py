"""
ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞµĞº Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ².
Ğ’Ñ‹Ğ½ĞµÑĞµĞ½ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ñ†Ğ¸ĞºĞ»Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ².
"""

from vkbottle import VKAPIError, API
from vkbottle.bot import Message
from datetime import datetime
import os

# Ğ¢Ğ¾ĞºĞµĞ½ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ„Ğ¾Ñ‚Ğ¾
ADMIN_USER_TOKEN = os.getenv("ADMIN_USER_TOKEN", "")
admin_api = None

if ADMIN_USER_TOKEN:
    admin_api = API(ADMIN_USER_TOKEN)


async def auto_update_card(api, user_db, debug_message: Message = None):
    """
    ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾Ğ³Ñ€Ğ°Ñ„Ğ¸Ğ¸ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ° Ğ² Ğ°Ğ»ÑŒĞ±Ğ¾Ğ¼Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹.
    
    Args:
        api: VK API ĞºĞ»Ğ¸ĞµĞ½Ñ‚ (Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ, Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½ Ğ´Ğ»Ñ ÑĞ¾Ğ²Ğ¼ĞµÑÑ‚Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸)
        user_db: ĞĞ±ÑŠĞµĞºÑ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸Ğ· Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
        debug_message: ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¾Ñ‚Ğ»Ğ°Ğ´Ğ¾Ñ‡Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸
    
    Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚:
        ADMIN_USER_TOKEN Ğ² .env Ñ„Ğ°Ğ¹Ğ»Ğµ - Ñ‚Ğ¾ĞºĞµĞ½ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
    """
    if not user_db.card_photo_id:
        if debug_message:
            await debug_message.answer(
                "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
                "â•‘  âŒ ĞĞ•Ğ¢ Ğ¤ĞĞ¢Ğ Ğ’ Ğ‘Ğ”!   â•‘\n"
                "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
                "Ğ’ Ğ±Ğ°Ğ·Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½ĞµÑ‚\n"
                "ID Ñ„Ğ¾Ñ‚Ğ¾ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°!\n\n"
                "ĞŸÑ€Ğ¸Ğ²ÑĞ¶Ğ¸ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºÑƒ:\n"
                "Ğ¡Ğ²ÑĞ·Ğ°Ñ‚ÑŒ photo-123_456 @user"
            )
        return

    if not admin_api:
        error_msg = (
            "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
            "â•‘  âš ï¸ ĞĞ¨Ğ˜Ğ‘ĞšĞ Ğ¢ĞĞšĞ•ĞĞ!   â•‘\n"
            "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
            "ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ ADMIN_USER_TOKEN!\n\n"
            "Ğ”Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ\n"
            "Ñ„Ğ¾Ñ‚Ğ¾ Ğ½ÑƒĞ¶ĞµĞ½ Ñ‚Ğ¾ĞºĞµĞ½ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°.\n\n"
            "Ğ”Ğ¾Ğ±Ğ°Ğ²ÑŒ Ğ² .env Ñ„Ğ°Ğ¹Ğ»:\n"
            "ADMIN_USER_TOKEN=Ğ²Ğ°Ñˆ_Ñ‚Ğ¾ĞºĞµĞ½"
        )
        print(error_msg, flush=True)
        if debug_message:
            await debug_message.answer(error_msg)
        return

    # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ ĞºÑ€Ğ°ÑĞ¸Ğ²Ğ¾Ğµ Ğ´Ğ¾ÑÑŒĞµ
    karma_status = ""
    if user_db.karma > 0:
        karma_status = f"âœ¨ Ğ£Ğ²Ğ°Ğ¶Ğ°ĞµĞ¼Ñ‹Ğ¹ ({user_db.karma:+d})"
    elif user_db.karma < 0:
        karma_status = f"ğŸ’© Ğ“Ğ½Ğ¸Ğ»ÑŒ ({user_db.karma:+d})"
    else:
        karma_status = "ğŸ˜ ĞĞµĞ¹Ñ‚Ñ€Ğ°Ğ» (0)"
    
    dossier_text = (
        f"â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        f"â•‘   ğŸ® Ğ”ĞĞ¡Ğ¬Ğ• Ğ˜Ğ“Ğ ĞĞšĞ   â•‘\n"
        f"â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
        f"â”Œâ”€ Ğ›Ğ˜Ğ§ĞĞ«Ğ• Ğ”ĞĞĞĞ«Ğ•\n"
        f"â”‚\n"
        f"â”œâ”€ ğŸ‘¤ {user_db.first_name}\n"
        f"â”œâ”€ ğŸ­ {user_db.get_rank()}\n"
        f"â”‚\n"
        f"â””â”€ ğŸ’° {user_db.balance:,} â‚½\n\n"
        f"â”Œâ”€ Ğ Ğ•ĞŸĞ£Ğ¢ĞĞ¦Ğ˜Ğ¯\n"
        f"â”‚\n"
        f"â””â”€ {karma_status}\n\n"
        f"â”Œâ”€ Ğ—ĞĞ ĞŸĞ›ĞĞ¢Ğ\n"
        f"â”‚\n"
        f"â””â”€ ğŸ’³ {user_db.rp_pending_balance:,} â‚½\n\n"
        f"{'â•' * 25}\n"
        f"ğŸ•’ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾:\n"
        f"   {datetime.now().strftime('%d.%m.%Y %H:%M')}\n"
        f"{'â•' * 25}\n\n"
        f"ChillLay RP | @chillayoff"
    )

    try:
        # ĞŸĞ°Ñ€ÑĞ¸Ğ¼ ID: "-123_456" -> owner_id=-123, photo_id=456
        owner_id, photo_id = map(int, user_db.card_photo_id.split('_'))

        # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ API Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ° Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        await admin_api.photos.edit(
            owner_id=owner_id,
            photo_id=photo_id,
            caption=dossier_text
        )

        print(f"âœ… ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾ {photo_id} Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ´Ğ»Ñ {user_db.first_name}.", flush=True)
        if debug_message:
            await debug_message.answer(
                f"â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
                f"â•‘  âœ… ĞšĞĞ Ğ¢ĞĞ§ĞšĞ ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ! â•‘\n"
                f"â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
                f"ğŸ‘¤ Ğ˜Ğ³Ñ€Ğ¾Ğº: {user_db.first_name}\n"
                f"ğŸ–¼ Ğ¤Ğ¾Ñ‚Ğ¾ ID: {photo_id}\n\n"
                f"Ğ”Ğ¾ÑÑŒĞµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾! âœ¨"
            )

    except VKAPIError as e:
        err_msg = getattr(e, "error_msg", str(e))
        err_text = (
            f"â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
            f"â•‘  ğŸ”¥ ĞĞ¨Ğ˜Ğ‘ĞšĞ VK API!   â•‘\n"
            f"â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
            f"ĞšĞ¾Ğ´ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸: {e.code}\n"
            f"ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: {err_msg}\n\n"
        )
        
        if e.code == 15:
            err_text += (
                "âš ï¸ ĞĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°!\n\n"
                "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ° Ñ‚Ğ¾ĞºĞµĞ½Ğ°:\n"
                "â€¢ Ğ¢Ğ¾ĞºĞµĞ½ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ\n"
                "  Ğ¾Ñ‚ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ°\n"
                "â€¢ ĞÑƒĞ¶Ğ½Ñ‹ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ½Ğ°\n"
                "  Ñ€ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ¾Ñ‚Ğ¾"
            )
        elif e.code == 100:
            err_text += (
                "âš ï¸ ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ ID Ñ„Ğ¾Ñ‚Ğ¾!\n\n"
                "ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ\n"
                "Ğ¿Ñ€Ğ¸Ğ²ÑĞ·ĞºĞ¸ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸."
            )
        
        print(err_text, flush=True)
        
        if debug_message:
            await debug_message.answer(err_text)
            
    except Exception as e:
        err_text = (
            f"â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
            f"â•‘  ğŸ”¥ Ğ¡Ğ˜Ğ¡Ğ¢Ğ•ĞœĞĞĞ¯ ĞĞ¨Ğ˜Ğ‘ĞšĞ! â•‘\n"
            f"â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n"
            f"Ğ§Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾ÑˆĞ»Ğ¾ Ğ½Ğµ Ñ‚Ğ°Ğº:\n"
            f"{e}\n\n"
            f"ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ÑÑŒ Ğº Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºÑƒ!"
        )
        print(err_text, flush=True)
        if debug_message:
            await debug_message.answer(err_text)
