from vkbottle import Bot
from database.models import User, SystemConfig
from utils.card_updater import auto_update_card
from settings import MAIN_CHAT_ID
from datetime import datetime
import asyncio

async def check_and_pay_salary(bot: Bot):
    """
    –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤—ã–ø–ª–∞—Ç–∞ –º–µ—Å—è—á–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç—ã.
    
    –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —á–∞—Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º.
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª –ª–∏ –Ω–æ–≤—ã–π –º–µ—Å—è—Ü, –∏ –µ—Å–ª–∏ –¥–∞ ‚Äî
    –≤—ã–ø–ª–∞—á–∏–≤–∞–µ—Ç –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—É—é –∑–∞—Ä–ø–ª–∞—Ç—É –∑–∞ –†–ü-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å.
    
    –ü—Ä–æ—Ü–µ—Å—Å:
    1. –°—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–ø–ª–∞—Ç–æ–π
    2. –ï—Å–ª–∏ –º–µ—Å—è—Ü –Ω–æ–≤—ã–π ‚Äî –Ω–∞—á–∏—Å–ª—è–µ—Ç rp_pending_balance –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—á—ë—Ç
    3. –û–±–Ω—É–ª—è–µ—Ç –º–µ—Å—è—á–Ω—ã–µ —Å—á—ë—Ç—á–∏–∫–∏ (rp_pending_balance –∏ rp_monthly_chars)
    4. –ü—É–±–ª–∏–∫—É–µ—Ç –æ—Ç—á—ë—Ç —Å —Ç–æ–ø–æ–º —Å–∞–º—ã—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
    5. –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
    """
    now = datetime.now()
    current_month_key = f"{now.year}-{now.month}" 
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ —É–∂–µ –≤—ã–ø–ª–∞—Ç–∞ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
    last_payout, _ = await SystemConfig.get_or_create(
        key="last_salary_month", 
        defaults={"value": ""}
    )

    # –ï—Å–ª–∏ —É–∂–µ –±—ã–ª–∞ –≤—ã–ø–ª–∞—Ç–∞ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
    if last_payout.value == current_month_key:
        return

    # === –í–´–î–ê–ß–ê –ó–ê–†–ü–õ–ê–¢–´ ===
    print("üí∞ –ù–∞—á–∞–ª–æ –≤—ã–ø–ª–∞—Ç—ã –º–µ—Å—è—á–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç—ã...")
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤ —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç–æ–π, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    users = await User.filter(rp_pending_balance__gt=0).order_by("-rp_monthly_chars").all()
    
    if not users:
        # –ù–∏–∫—Ç–æ –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞–ª –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ
        last_payout.value = current_month_key
        await last_payout.save()
        print("üí§ –ù–µ—Ç –∏–≥—Ä–æ–∫–æ–≤ —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π –∑–∞—Ä–ø–ª–∞—Ç–æ–π")
        return

    # === –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –û–¢–ß–Å–¢–ê ===
    report = (
        f"‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n"
        f"    üí∏ –í–´–ü–õ–ê–¢–ê –ó–ê–†–ü–õ–ê–¢–´\n"
        f"‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n"
        f"üìÖ –ú–µ—Å—è—Ü –∑–∞–≤–µ—Ä—à—ë–Ω!\n"
        f"üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–∞ –≤—Å–µ–º –∏–≥—Ä–æ–∫–∞–º.\n\n"
        f"‚îè‚îÅ‚îÅ‚îÅ‚îÅ üèÜ –¢–û–ü –ê–ö–¢–ò–í–ù–´–• ‚îÅ‚îÅ‚îÅ‚îÅ‚îì\n"
        f"‚îÇ\n"
    )

    medals = ["ü•á", "ü•à", "ü•â"]
    
    # –í—ã–ø–ª–∞—á–∏–≤–∞–µ–º –∑–∞—Ä–ø–ª–∞—Ç—É –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Ç–æ–ø
    for i, user in enumerate(users):
        amount = user.rp_pending_balance
        
        # –ü–µ—Ä–µ–≤–æ–¥–∏–º —Å –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å—á—ë—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π
        user.balance += amount
        user.rp_pending_balance = 0
        user.rp_monthly_chars = 0  # –°–±—Ä–æ—Å –º–µ—Å—è—á–Ω–æ–≥–æ —Å—á—ë—Ç—á–∏–∫–∞ —Å–∏–º–≤–æ–ª–æ–≤
        await user.save()
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∏–≥—Ä–æ–∫–∞
        await auto_update_card(bot.api, user)
        await asyncio.sleep(0.5)  # –ó–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∑–∏—Ç—å API

        # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–æ–ø –ø–µ—Ä–≤—ã—Ö 10 –∏–≥—Ä–æ–∫–æ–≤
        if i < 10:
            if i < 3:
                medal = medals[i]
            else:
                medal = f" {i+1}."
            
            report += f"‚îÇ {medal} {user.first_name}\n"
            report += f"‚îÇ    üí∞ {amount:,} —á–∏–ª–ª–∏–∫–æ–≤\n"
            report += f"‚îÇ\n"

    report += (
        "‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ\n\n"
        "üìä –í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤ –ø–æ–ª—É—á–∏–ª–∏: {}\n\n"
        "üí° –ü—Ä–æ–¥–æ–ª–∂–∞–π –ø–∏—Å–∞—Ç—å –†–ü-–ø–æ—Å—Ç—ã,\n"
        "   —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –±–æ–ª—å—à–µ!"
    ).format(len(users))

    # –ü—É–±–ª–∏–∫—É–µ–º –æ—Ç—á—ë—Ç –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç
    if MAIN_CHAT_ID != 0:
        try: 
            await bot.api.messages.send(
                peer_id=MAIN_CHAT_ID, 
                message=report, 
                random_id=0
            )
            print(f"‚úÖ –û—Ç—á—ë—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ —á–∞—Ç {MAIN_CHAT_ID}")
        except Exception as e:
            print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç—á—ë—Ç –≤ —á–∞—Ç: {e}")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–µ—Ç–∫—É –æ –≤—ã–ø–ª–∞—Ç–µ
    last_payout.value = current_month_key
    await last_payout.save()
    
    print(f"‚úÖ –ó–∞—Ä–ø–ª–∞—Ç–∞ –≤—ã–ø–ª–∞—á–µ–Ω–∞ {len(users)} –∏–≥—Ä–æ–∫–∞–º")
